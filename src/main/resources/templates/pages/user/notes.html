<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">
<head th:replace="~{fragments/head :: common-head}">
    <!-- 共通のhead部分がここに挿入されます -->
</head>
<body class="bg-gray-50">
    <div th:replace="~{fragments/header :: common-header}"></div>
    
    <div class="container mx-auto p-4">
        <div class="flex">
            <!-- サイドバー -->
            <div class="w-1/4 bg-white rounded-lg shadow-md p-6 mr-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700">ノート一覧</h2>
                    <button onclick="createNewNote()" class="group relative inline-flex items-center justify-center bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out transform hover:-translate-y-0.5">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        <span class="ml-2">新規作成</span>
                    </button>
                </div>
                <ul id="noteList" class="space-y-2">
                    <!-- ノート一覧がここに動的に追加されます -->
                </ul>
            </div>
            
            <!-- メインコンテンツ -->
            <div class="w-3/4 bg-white rounded-lg shadow-md p-6">
                <div id="preview" class="prose max-w-none">
                    <!-- ノートの内容がここに表示されます -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast UI Editor -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/3.0.0/toastui-editor.min.css" />
    <script src="https://uicdn.toast.com/editor/3.0.0/toastui-editor-all.min.js"></script>

    <script th:inline="javascript">
        // ユーザーIDをサーバーサイドから取得
        const userId = /*[[${#authentication.principal.id}]]*/ 1;
        let currentNoteId = null;

        // Toast UI Editor のインスタンスを作成
        const editor = new toastui.Editor.factory({
            el: document.querySelector('#preview'),
            height: '100%',
            initialEditType: 'preview',
            previewStyle: 'vertical',
            toolbarItems: [], // ツールバーを非表示
            hideModeSwitch: true, // モード切り替えを非表示
            readOnly: true, // 読み取り専用モード
            viewer: true // ビューアーモードで初期化
        });

        function loadNotes() {
            fetch(`/api/notes?userId=${userId}`)
                .then(response => response.json())
                .then(notes => {
                    const noteList = document.getElementById('noteList');
                    noteList.innerHTML = '';
                    notes.forEach(note => {
                        const li = document.createElement('li');
                        li.className = 'p-3 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200';
                        li.textContent = note.title;
                        li.onclick = () => loadNote(note.id);
                        noteList.appendChild(li);
                    });
                });
        }

        function loadNote(id) {
            fetch(`/api/notes/${id}?userId=${userId}`)
                .then(response => response.json())
                .then(note => {
                    currentNoteId = note.id;
                    const createdAt = new Date(note.createdAt).toLocaleString('ja-JP');
                    const updatedAt = new Date(note.updatedAt).toLocaleString('ja-JP');

                    // タイトルと日時情報を追加
                    const content = `# ${note.title}\n\n` +
                        `作成日時: ${createdAt}\n` +
                        `更新日時: ${updatedAt}\n\n` +
                        `---\n\n` +
                        note.content;

                    // Toast UI Editor にコンテンツを設定
                    editor.setMarkdown(content);

                    // アクティブなノートをハイライト
                    document.querySelectorAll('#noteList li').forEach(item => {
                        item.classList.remove('bg-blue-50', 'text-blue-700');
                    });
                    event.target.classList.add('bg-blue-50', 'text-blue-700');
                });
        }

        function createNewNote() {
            const note = {
                title: '新規ノート',
                content: '',
                userId: userId
            };
            fetch('/api/notes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(note)
            })
            .then(response => response.json())
            .then(() => {
                loadNotes();
            });
        }

        // 初期ロード
        loadNotes();
    </script>
</body>
</html> 