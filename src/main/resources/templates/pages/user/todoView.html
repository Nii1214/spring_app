<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">
<head th:replace="~{fragments/head :: common-head}">
    <!-- 共通のhead部分がここに挿入されます -->
</head>
<body class="bg-gray-50">
    <div th:replace="~{fragments/header :: common-header}"></div>
    <div class="container mx-auto p-4 max-w-4xl">        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex flex-row justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">ToDoリスト</h2>
                <button id="newTodoBtn" class="group relative inline-flex items-center justify-center bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-2.5 px-4 sm:px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 ease-in-out transform hover:-translate-y-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    <span class="hidden sm:inline ml-2">新規登録</span>
                </button>
            </div>
            
            <!-- タブ -->
            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="incomplete-tab" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        未完了
                    </button>
                    <button id="complete-tab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        完了済み
                    </button>
                </nav>
            </div>

            <!-- 新規登録モーダル -->
            <div id="newTodoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-4 sm:p-5 border w-[90%] sm:w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Todo登録</h3>
                        <form id="newTodoForm">
                            <div class="mb-4">
                                <label for="title" class="block text-sm font-medium text-gray-700">タイトル</label>
                                <input type="text" id="title" name="title" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="priority" class="block text-sm font-medium text-gray-700">優先度</label>
                                <select id="priority" name="priority" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="高">高</option>
                                    <option value="中">中</option>
                                    <option value="低">低</option>
                                </select>
                            </div>
                            <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-3">
                                <button type="submit"
                                    class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded">
                                    登録
                                </button>
                                <button type="button" id="cancelBtn"
                                    class="w-full sm:w-auto bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded">
                                    キャンセル
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 未完了のTodo -->
            <div id="incomplete-todos" class="overflow-x-auto">
                <table id="incompleteTodoTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-12"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">タイトル</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:each="todo : ${incompleteTodos}" class="hover:bg-gray-50">
                            <td class="px-2 py-4 text-center">
                                <input type="checkbox" 
                                       class="form-checkbox h-5 w-5 text-blue-600 todo-checkbox" 
                                       th:value="${todo.id}" 
                                       th:data-todo-id="${todo.id}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" th:text="${todo.getTitle()}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 完了済みのTodo -->
            <div id="complete-todos" class="overflow-x-auto hidden">
                <table id="completeTodoTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-12"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">タイトル</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:each="todo : ${completeTodos}" class="hover:bg-gray-50">
                            <td class="px-2 py-4 text-center">
                                <input type="checkbox" 
                                       class="form-checkbox h-5 w-5 text-blue-600 todo-checkbox" 
                                       th:value="${todo.id}" 
                                       th:data-todo-id="${todo.id}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" th:text="${todo.getTitle()}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // タブ切り替え
            $('#incomplete-tab').click(function() {
                $(this).addClass('border-blue-500 text-blue-600').removeClass('border-transparent text-gray-500');
                $('#complete-tab').addClass('border-transparent text-gray-500').removeClass('border-blue-500 text-blue-600');
                $('#incomplete-todos').removeClass('hidden');
                $('#complete-todos').addClass('hidden');
            });

            $('#complete-tab').click(function() {
                $(this).addClass('border-blue-500 text-blue-600').removeClass('border-transparent text-gray-500');
                $('#incomplete-tab').addClass('border-transparent text-gray-500').removeClass('border-blue-500 text-blue-600');
                $('#complete-todos').removeClass('hidden');
                $('#incomplete-todos').addClass('hidden');
            });

            // チェックボックスの変更イベントハンドラ
            $(document).on('change', '.todo-checkbox', function() {
                const $checkbox = $(this);
                const todoId = $checkbox.data('todo-id');
                const isCompleted = $checkbox.prop('checked');
                const $row = $checkbox.closest('tr');

                $.ajax({
                    url: `/api/todos/${todoId}/status`,
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify(isCompleted),
                    success: function() {
                        // 成功時の処理
                        if (isCompleted) {
                            // 完了タブに移動
                            $row.detach().appendTo('#completeTodoTable tbody');
                        } else {
                            // 未完了タブに移動
                            $row.detach().appendTo('#incompleteTodoTable tbody');
                        }
                    },
                    error: function() {
                        // エラー時の処理
                        alert('更新に失敗しました');
                        $checkbox.prop('checked', !isCompleted);
                    }
                });
            });

            // DataTable初期化
            $('#incompleteTodoTable').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json'
                },
                searching: false,
                paging: false,
                info: false,
                dom: 'rt',
                autoWidth: false,
                columnDefs: [
                    { width: '48px', targets: 0 }
                ]
            });

            $('#completeTodoTable').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json'
                },
                searching: false,
                paging: false,
                info: false,
                dom: 'rt',
                autoWidth: false,
                columnDefs: [
                    { width: '48px', targets: 0 }
                ]
            });

            // モーダル関連の処理
            const $modal = $('#newTodoModal');
            const $modalContent = $modal.find('.relative'); // モーダルの内容部分
            const $newTodoBtn = $('#newTodoBtn');
            const $cancelBtn = $('#cancelBtn');
            const $form = $('#newTodoForm');

            // モーダルを開く
            $newTodoBtn.on('click', function(e) {
                e.stopPropagation();
                $modal.removeClass('hidden');
            });

            // モーダルを閉じる関数
            function closeModal() {
                $modal.addClass('hidden');
                $form[0].reset();
            }

            // キャンセルボタンで閉じる
            $cancelBtn.on('click', function(e) {
                e.stopPropagation();
                closeModal();
            });

            // モーダルの背景（オーバーレイ）をクリックした時に閉じる
            $modal.on('click', function(e) {
                // クリックされた要素がモーダルの内容部分でない場合
                if (!$(e.target).closest('.relative').length) {
                    closeModal();
                }
            });

            // フォーム送信
            $form.on('submit', function(e) {
                e.preventDefault();
                const formData = {
                    title: $('#title').val(),
                    priority: $('#priority').val(),
                    status: '未着手'
                };

                $.ajax({
                    url: '/api/todos',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        closeModal();
                        location.reload();
                    },
                    error: function() {
                        alert('登録に失敗しました');
                    }
                });
            });
        });
    </script>
</body>
</html>
