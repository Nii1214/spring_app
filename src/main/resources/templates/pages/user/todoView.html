<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">
<head th:replace="~{fragments/head :: common-head}">
    <!-- 共通のhead部分がここに挿入されます -->
</head>
<body class="bg-gray-50">
    <div th:replace="~{fragments/header :: common-header}"></div>
    <div class="container mx-auto p-4 max-w-4xl">        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">ToDoリスト</h2>
            
            <!-- タブ -->
            <div class="border-b border-gray-200 mb-4">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="incomplete-tab" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        未完了
                    </button>
                    <button id="complete-tab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        完了済み
                    </button>
                </nav>
            </div>

            <!-- 未完了のTodo -->
            <div id="incomplete-todos" class="overflow-x-auto">
                <table id="incompleteTodoTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-12"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">タイトル</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:each="todo : ${incompleteTodos}" class="hover:bg-gray-50">
                            <td class="px-2 py-4 text-center">
                                <input type="checkbox" 
                                       class="form-checkbox h-5 w-5 text-blue-600 todo-checkbox" 
                                       th:value="${todo.id}" 
                                       th:data-todo-id="${todo.id}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" th:text="${todo.getTitle()}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 完了済みのTodo -->
            <div id="complete-todos" class="overflow-x-auto hidden">
                <table id="completeTodoTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-12"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">タイトル</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:each="todo : ${completeTodos}" class="hover:bg-gray-50">
                            <td class="px-2 py-4 text-center">
                                <input type="checkbox" 
                                       class="form-checkbox h-5 w-5 text-blue-600 todo-checkbox" 
                                       th:value="${todo.id}" 
                                       th:data-todo-id="${todo.id}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" th:text="${todo.getTitle()}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // タブ切り替え
            $('#incomplete-tab').click(function() {
                $(this).addClass('border-blue-500 text-blue-600').removeClass('border-transparent text-gray-500');
                $('#complete-tab').addClass('border-transparent text-gray-500').removeClass('border-blue-500 text-blue-600');
                $('#incomplete-todos').removeClass('hidden');
                $('#complete-todos').addClass('hidden');
            });

            $('#complete-tab').click(function() {
                $(this).addClass('border-blue-500 text-blue-600').removeClass('border-transparent text-gray-500');
                $('#incomplete-tab').addClass('border-transparent text-gray-500').removeClass('border-blue-500 text-blue-600');
                $('#complete-todos').removeClass('hidden');
                $('#incomplete-todos').addClass('hidden');
            });

            // チェックボックスの変更イベントハンドラ
            $(document).on('change', '.todo-checkbox', function() {
                const $checkbox = $(this);
                const todoId = $checkbox.data('todo-id');
                const isCompleted = $checkbox.prop('checked');
                const $row = $checkbox.closest('tr');

                $.ajax({
                    url: `/api/todos/${todoId}/status`,
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify(isCompleted),
                    success: function() {
                        // 成功時の処理
                        if (isCompleted) {
                            // 完了タブに移動
                            $row.detach().appendTo('#completeTodoTable tbody');
                        } else {
                            // 未完了タブに移動
                            $row.detach().appendTo('#incompleteTodoTable tbody');
                        }
                    },
                    error: function() {
                        // エラー時の処理
                        alert('更新に失敗しました');
                        $checkbox.prop('checked', !isCompleted);
                    }
                });
            });

            // DataTable初期化
            $('#incompleteTodoTable').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json'
                },
                searching: false,
                paging: false,
                info: false,
                dom: 'rt',
                autoWidth: false,
                columnDefs: [
                    { width: '48px', targets: 0 }
                ]
            });

            $('#completeTodoTable').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/ja.json'
                },
                searching: false,
                paging: false,
                info: false,
                dom: 'rt',
                autoWidth: false,
                columnDefs: [
                    { width: '48px', targets: 0 }
                ]
            });
        });
    </script>
</body>
</html>
